<!-- dashboard.component.html -->
<div class="dashboard-container">

  <!-- Header avec filtres -->
  <div class="dashboard-header">
    <div class="header-content">
      <div class="header-info">
        <h1 class="dashboard-title">Tableau de bord</h1>
        <p class="dashboard-subtitle">Vue d'ensemble de votre agence de location</p>
      </div>

      <div class="header-actions">
        <mat-form-field appearance="outline" class="period-select">
          <mat-label>Période</mat-label>
          <mat-select [value]="selectedPeriod" (selectionChange)="onPeriodChange($event.value)">
            <mat-option value="jour">Aujourd'hui</mat-option>
            <mat-option value="semaine">Cette semaine</mat-option>
            <mat-option value="mois">Ce mois</mat-option>
            <mat-option value="annee">Cette année</mat-option>
          </mat-select>
        </mat-form-field>

        <button mat-raised-button color="primary" (click)="refreshData()" class="refresh-btn">
          <mat-icon>refresh</mat-icon>
          Actualiser
        </button>
      </div>
    </div>
  </div>

  <!-- Chargement -->
  <div *ngIf="loading" class="loading-container">
    <mat-progress-bar mode="indeterminate" color="primary"></mat-progress-bar>
    <p>Chargement du tableau de bord...</p>
  </div>

  <!-- Contenu principal -->
  <div *ngIf="!loading && dashboardData" class="dashboard-content">

    <!-- Cards de statistiques principales -->
    <div class="stats-grid">
      <mat-card *ngFor="let card of getStatCards()" class="stat-card" [ngClass]="'stat-card-' + card.color">
        <mat-card-content class="stat-card-content">
          <div class="stat-icon">
            <mat-icon>{{ card.icon }}</mat-icon>
          </div>
          <div class="stat-info">
            <h3 class="stat-value">{{ card.value }}</h3>
            <p class="stat-title">{{ card.title }}</p>
            <div class="stat-trend" *ngIf="card.trend">
              <mat-icon [class.trend-positive]="card.trend.isPositive" [class.trend-negative]="!card.trend.isPositive">
                {{ card.trend.isPositive ? 'trending_up' : 'trending_down' }}
              </mat-icon>
              <span [class.trend-positive]="card.trend.isPositive" [class.trend-negative]="!card.trend.isPositive">
                {{ card.trend.value }}% {{ card.trend.period }}
              </span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Graphiques -->
    <div class="charts-grid">

      <!-- Graphique des revenus -->
      <mat-card class="chart-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>trending_up</mat-icon>
            Évolution des revenus et réservations
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="chart-container">
            <canvas
              baseChart
              [data]="revenueChartData"
              [options]="revenueChartOptions"
              type="line">
            </canvas>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Graphique des statuts de réservations -->
      <mat-card class="chart-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>pie_chart</mat-icon>
            Répartition des réservations
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="chart-container">
            <canvas
              baseChart
              [data]="reservationStatusChartData"
              [options]="statusChartOptions"
              type="doughnut">
            </canvas>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Section des informations détaillées -->
    <div class="details-grid">

      <!-- Statistiques véhicules -->
      <mat-card class="details-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>directions_car</mat-icon>
            État du parc automobile
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="vehicle-stats">
            <div class="vehicle-stat-item">
              <div class="vehicle-stat-number">{{ dashboardData.vehicleStats.totalVehicules }}</div>
              <div class="vehicle-stat-label">Total véhicules</div>
            </div>
            <div class="vehicle-stat-item available">
              <div class="vehicle-stat-number">{{ dashboardData.vehicleStats.vehiculesDisponibles }}</div>
              <div class="vehicle-stat-label">Disponibles</div>
            </div>
            <div class="vehicle-stat-item rented">
              <div class="vehicle-stat-number">{{ dashboardData.vehicleStats.vehiculesLoues }}</div>
              <div class="vehicle-stat-label">En location</div>
            </div>
            <div class="vehicle-stat-item maintenance">
              <div class="vehicle-stat-number">{{ dashboardData.vehicleStats.vehiculesEnMaintenance }}</div>
              <div class="vehicle-stat-label">Maintenance</div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Véhicules populaires -->
      <mat-card class="details-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>star</mat-icon>
            Véhicules les plus demandés
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="popular-vehicles">
            <div *ngFor="let vehicle of dashboardData.popularVehicles.slice(0, 5)" class="popular-vehicle-item">
              <div class="vehicle-image">
                <img [src]="vehicle.imageUrl" [alt]="vehicle.nom" *ngIf="vehicle.imageUrl">
                <mat-icon *ngIf="!vehicle.imageUrl">directions_car</mat-icon>
              </div>
              <div class="vehicle-info">
                <h4>{{ vehicle.marque }} {{ vehicle.nom }}</h4>
                <p>{{ vehicle.nombreReservations }} réservations</p>
              </div>
              <div class="vehicle-revenue">
                <span>{{ formatCurrency(vehicle.revenus) }}</span>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Réservations récentes -->
    <mat-card class="recent-reservations-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>schedule</mat-icon>
          Réservations récentes
        </mat-card-title>
        <mat-card-subtitle>
          Les 10 dernières réservations
        </mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="table-container">
          <table mat-table [dataSource]="dashboardData.recentReservations" class="reservations-table">

            <!-- Colonne Client -->
            <ng-container matColumnDef="client">
              <th mat-header-cell *matHeaderCellDef>Client</th>
              <td mat-cell *matCellDef="let reservation">
                <div class="client-info">
                  <div class="client-name">{{ reservation.clientPrenom }} {{ reservation.clientNom }}</div>
                </div>
              </td>
            </ng-container>

            <!-- Colonne Véhicule -->
            <ng-container matColumnDef="vehicule">
              <th mat-header-cell *matHeaderCellDef>Véhicule</th>
              <td mat-cell *matCellDef="let reservation">
                <div class="vehicle-info">
                  <strong>{{ reservation.vehicule }}</strong>
                </div>
              </td>
            </ng-container>

            <!-- Colonne Dates -->
            <ng-container matColumnDef="dates">
              <th mat-header-cell *matHeaderCellDef>Période</th>
              <td mat-cell *matCellDef="let reservation">
                <div class="dates-info">
                  <small>{{ getDatesString(reservation.dateDepart, reservation.dateRetour) }}</small>
                </div>
              </td>
            </ng-container>

            <!-- Colonne Statut -->
            <ng-container matColumnDef="statut">
              <th mat-header-cell *matHeaderCellDef>Statut</th>
              <td mat-cell *matCellDef="let reservation">
                <mat-chip-set>
                  <mat-chip [class]="'status-chip-' + getStatusColor(reservation.statut)">
                    {{ getStatusLabel(reservation.statut) }}
                  </mat-chip>
                </mat-chip-set>
              </td>
            </ng-container>

            <!-- Colonne Montant -->
            <ng-container matColumnDef="montant">
              <th mat-header-cell *matHeaderCellDef>Montant</th>
              <td mat-cell *matCellDef="let reservation">
                <div class="amount">
                  <strong>{{ formatCurrency(reservation.montant) }}</strong>
                </div>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="reservation-row"></tr>
          </table>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>
